# NOTE: Only builds the web app in apps/web.
# Execution APIs (apps/link-api, apps/trade-api) are NOT deployed on Netlify.
[build]
  base = "apps/web"
  command = "cd ../.. && npm install && cd apps/web && ln -sf ../../node_modules node_modules && npm run build"
  publish = ".next"
  # Skip build when:
  #  - commit message includes [skip netlify], OR
  #  - changes do not touch apps/web (monorepo optimization)
  ignore = """bash -lc '
    if git log -1 --pretty=%B | grep -qi \"\\[skip netlify\\]\"; then exit 0; fi;
    FROM=${CACHED_COMMIT_REF:-HEAD~1}; TO=${COMMIT_REF:-HEAD};
    if git diff --quiet \"$FROM\" \"$TO\" -- apps/web; then exit 0; else exit 1; fi
  '"""

[[plugins]]
  package = "@netlify/plugin-nextjs"

## Portal routing
## 1) Canonicalize shorthand to the portal page
[[redirects]]
  from = "/link"
  to = "/link/exec"
  status = 301

## 2) If someone opens a portal path on battle.smtm.ai, send them to the main site
[[redirects]]
  from = "https://battle.smtm.ai/link/*"
  to = "https://www.smtm.ai/link/:splat"
  status = 301
  force = true

[[redirects]]
  from = "https://battle.smtm.ai/*"
  to = "https://smtm-wordle.ventuss.workers.dev/:splat"
  status = 200
  force = true
